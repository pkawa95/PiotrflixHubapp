<!doctype html>
<html lang="pl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Piotrflix</title>

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Piotrflix">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0b12">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f5f7fb">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg-dark:#0b0b12; --bg-light:#f5f7fb;
      --card-dark:rgba(22,22,34,.78); --card-light:rgba(255,255,255,.88);
      --accent:#c600ff; --accent-2:#00f0ff;
      --nav-bg-dark:rgba(16,18,28,.92); --nav-bg-light:rgba(255,255,255,.94);
    }
    html,body{height:100%; background:#0b0b12;}
    @media (prefers-color-scheme:light){ html,body{background:#f5f7fb;} }
    body[data-theme="dark"]{ color:#eef2ff; }
    body[data-theme="light"]{ color:#0a0a0f; }

    .card{
      background:var(--card-dark);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(12px) saturate(120%);
    }
    body[data-theme="light"] .card{
      background:var(--card-light); border-color:rgba(0,0,0,.08);
    }

    .pill-active{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff !important;
      box-shadow:0 0 0 1px rgba(255,255,255,.08) inset;
    }

    .navx{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      display:grid; grid-template-columns:repeat(4,1fr);
      background:var(--nav-bg-dark); border-top:1px solid rgba(255,255,255,.15);
      backdrop-filter:blur(12px) saturate(120%);
      padding-bottom: env(safe-area-inset-bottom);
    }
    body[data-theme="light"] .navx{ background:var(--nav-bg-light); border-top-color:rgba(0,0,0,.10); }
    .navx button{ padding:.7rem .25rem; display:grid; grid-template-rows:24px auto; place-items:center; font-weight:800; }
    .navx .ico{ width:22px; height:22px; }

    .view{ display:none; }
    .view.active{ display:block; animation:fade .2s ease; }
    @keyframes fade{ from{ opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

    .auth-wrap{ overflow:hidden; }
    .auth-rail{ display:flex; width:200%; transition: transform .28s ease; }
    .auth-pane{ width:100%; padding:1rem; }
    .auth-tab{ cursor:pointer; padding:.65rem 1rem; border-radius:999px; font-weight:800; }
    .auth-tab.active{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; }

    .tabs{ display:flex; gap:.5rem; overflow-x:auto; padding:.35rem; }
    .tab{ flex:1 1 auto; min-width:120px; text-align:center; padding:.65rem 1rem; border-radius:999px; font-weight:800; }
    .tab.active{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; }

    .tile{ display:flex; gap:.75rem; padding:1rem; border-radius:16px; border:1px solid rgba(255,255,255,.14); }
    .tile img{ width:86px; aspect-ratio:2/3; object-fit:cover; border-radius:10px; }
    .progress{ height:10px; border-radius:10px; background:linear-gradient(180deg,#1b1b29,#131320); overflow:hidden; }
    .progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); }

    .hidden-soft{ display:none !important; }
    .safe-bottom{ padding-bottom: calc(5rem + env(safe-area-inset-bottom)); }

    .del-badge{
      position:absolute;top:8px;right:8px;font-size:12px;padding:3px 8px;border-radius:999px;
      border:1px solid #3a1a27;background:linear-gradient(180deg,#4a1420,#3b0f1a);color:#fecaca;
      box-shadow:0 2px 8px rgba(0,0,0,.35)
    }
    .del-badge.warn{border-color:#3a2f1a;background:linear-gradient(180deg,#4a3314,#3b2a0f);color:#fff3c4}
    .del-badge.ok{border-color:#183a2a;background:linear-gradient(180deg,#144a2f,#0f3b24);color:#d1fae5}
  </style>
</head>
<body class="min-h-screen" data-theme="dark">

  <!-- HEADER -->
  <header class="sticky top-0 z-10 backdrop-blur border-b border-white/10 bg-black/20 body[data-theme='light']:bg-white/70">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="font-extrabold tracking-wide">Piotrflix</h1>
      <div class="flex items-center gap-3 text-sm">
        <span id="who" class="opacity-80">niezalogowany</span>
        <label class="inline-flex items-center gap-2 cursor-pointer">
          <input id="themeToggle" type="checkbox" class="sr-only">
          <span class="px-3 py-1 rounded-full border border-white/20">☀️/🌙</span>
        </label>
      </div>
    </div>
  </header>

  <!-- APP WRAPPER -->
  <main class="max-w-4xl mx-auto px-4 pt-6 pb-28 safe-bottom">

    <!-- AUTH -->
    <section id="auth" class="view">
      <div class="mb-4 flex items-center justify-center gap-2">
        <button id="tabLogin" class="auth-tab active">Zaloguj</button>
        <button id="tabRegister" class="auth-tab">Zarejestruj</button>
      </div>

      <div class="auth-wrap card">
        <div id="authRail" class="auth-rail">
          <!-- LOGIN -->
          <div class="auth-pane">
            <h2 class="font-bold text-lg mb-2">Witaj ponownie</h2>
            <div class="grid gap-3">
              <input id="loginEmail" class="card px-4 py-3" placeholder="Email" autocomplete="username" value="dev@localhost">
              <input id="loginPass" type="password" class="card px-4 py-3" placeholder="Hasło" autocomplete="current-password" value="dev">
              <button id="btnLogin" class="px-4 py-3 rounded-xl font-extrabold"
                style="background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff;">Zaloguj</button>
              <div id="loginMsg" class="text-sm opacity-80"></div>
            </div>
          </div>

          <!-- REGISTER -->
          <div class="auth-pane">
            <h2 class="font-bold text-lg mb-2">Utwórz konto</h2>
            <div class="grid gap-3">
              <input id="regEmail" class="card px-4 py-3" placeholder="Email" autocomplete="email">
              <input id="regPass" type="password" class="card px-4 py-3" placeholder="Hasło" autocomplete="new-password">
              <input id="regPass2" type="password" class="card px-4 py-3" placeholder="Powtórz hasło" autocomplete="new-password">
              <button id="btnRegister" class="px-4 py-3 rounded-xl font-extrabold"
                style="background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff;">Zarejestruj</button>
              <div id="regMsg" class="text-sm opacity-80"></div>
            </div>
          </div>
        </div>
      </div>
      <p class="text-center text-sm opacity-80 mt-3">Przesuń palcem, by przełączyć kartę.</p>
    </section>

    <!-- TORRENTS -->
    <section id="torrents" class="view">
      <h2 class="font-bold text-xl mb-3">Torrenty</h2>

      <div class="card p-3 mb-3 grid gap-2">
        <div class="flex items-center gap-2 flex-wrap">
          <select id="deviceSel" class="card px-3 py-2"></select>
          <button id="devRefresh" class="px-3 py-2 rounded-lg card">🔄 Odśwież urządzenia</button>
          <span id="devInfo" class="text-sm opacity-80">—</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <input id="globRate" type="number" step="0.1" class="card px-3 py-2" placeholder="global MiB/s (≤0=OFF)" style="width:220px">
          <button id="setGlobRate" class="px-3 py-2 rounded-lg card">Ustaw globalny limit</button>
          <label class="inline-flex items-center gap-2 text-sm ml-auto">
            <input id="hideDone" type="checkbox"><span>Ukryj zakończone</span>
          </label>
          <button id="tRefresh" class="px-3 py-2 rounded-lg card">🔄 Odśwież</button>
          <button id="tAuto" class="px-3 py-2 rounded-lg card">Auto: OFF</button>
        </div>
      </div>

      <div id="tInfo" class="text-sm opacity-80 mb-2">—</div>
      <div id="torList" class="grid gap-3"></div>
    </section>

    <!-- SEARCH -->
    <section id="search" class="view">
      <h2 class="font-bold text-xl mb-3">Szukaj</h2>
      <div class="tabs mb-3" id="searchTabs">
        <button class="tab active" data-src="yts_html">🎬 YTS HTML</button>
        <button class="tab" data-src="tpb">🏴‍☠️ TPB FILMY</button>
        <button class="tab" data-src="tpb_series">📺 TPB SERIALE</button>
      </div>
      <div class="grid gap-2 sm:grid-cols-[1fr_auto]">
        <input id="q" class="card px-4 py-3" placeholder="Szukaj tytułu…">
        <button id="btnSearch" class="px-4 py-3 rounded-xl font-extrabold pill-active">🔍 Szukaj</button>
      </div>
      <div class="flex items-center gap-2 mt-2">
        <select id="mtype" class="card px-3 py-2">
          <option value="movie" selected>movie</option>
          <option value="series">series</option>
        </select>
        <select id="qualitySel" class="card px-3 py-2">
          <option value="">auto jakość</option>
          <option value="2160p">2160p</option>
          <option value="1080p" selected>1080p</option>
          <option value="720p">720p</option>
        </select>
        <input id="tmdbKey" class="card px-3 py-2" placeholder="TMDb API key (opcjonalnie)" style="width:240px">
        <span id="searchInfo" class="text-sm opacity-80 ml-auto"></span>
      </div>
      <div id="searchResults" class="mt-3 grid gap-3"></div>
    </section>

    <!-- AVAILABLE -->
    <section id="available" class="view">
      <h2 class="font-bold text-xl mb-3">Dostępne</h2>
      <div class="card p-3 mb-3 grid gap-2">
        <div class="flex items-center gap-2 flex-wrap">
          <input id="avQuery" class="card px-3 py-2" placeholder="Szukaj w dostępnych..." style="min-width:220px;flex:1">
          <select id="avKind" class="card px-3 py-2">
            <option value="all" selected>all</option>
            <option value="movie">movie</option>
            <option value="series">series</option>
          </select>
          <select id="avSort" class="card px-3 py-2">
            <option value="recent" selected>ostatnio aktualizowane</option>
            <option value="title">tytuł A→Z</option>
            <option value="progress">postęp malejąco</option>
          </select>
          <button id="avRefresh" class="px-3 py-2 rounded-lg card">🔄 Odśwież</button>
          <button id="avAuto" class="px-3 py-2 rounded-lg card">Auto: OFF</button>
          <span id="avInfo" class="text-sm opacity-80 ml-auto">—</span>
        </div>
      </div>
      <div id="avGrid" class="grid gap-3"></div>
    </section>

    <!-- OPTIONS -->
    <section id="options" class="view">
      <h2 class="font-bold text-xl mb-3">Opcje</h2>
      <div class="card p-4 grid gap-3">
        <div class="text-sm">Backend: <code class="px-2 py-1 rounded bg-black/30" id="baseUrlLabel"></code> (CORS włączony)</div>
        <button id="btnLogout" class="px-4 py-3 rounded-xl font-extrabold"
          style="background:linear-gradient(135deg,#ff3b30,#ff9500); color:#fff;">🚪 Wyloguj</button>
      </div>
    </section>

  </main>

  <!-- BOTTOM NAV -->
  <nav class="navx" role="tablist" aria-label="Główna nawigacja">
    <button data-view="torrents">
      <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a4 4 0 0 0-4 4v2H6v2h12V9h-2V7a4 4 0 0 0-4-4Zm-1 11.59V9h2v5.59l1.29-1.3 1.42 1.42-3.7 3.7a1 1 0 0 1-1.42 0l-3.7-3.7 1.42-1.42L11 14.59ZM5 20a2 2 0 0 1-2-2v-4h2v4h14v-4h2v4a2 2 0 0 1-2 2H5z"/></svg>
      <span class="text-xs font-extrabold">Torrenty</span>
    </button>
    <button data-view="search">
      <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 1 0 5.29 14.02l4.84 4.85 1.41-1.42-4.83-4.84A8 8 0 0 0 10 2z"/></svg>
      <span class="text-xs font-extrabold">Szukaj</span>
    </button>
    <button data-view="available">
      <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h3v3H4V4Zm0 6h3v3H4v-3Zm0 6h3v3H4v-3ZM9 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H9V4Z"/></svg>
      <span class="text-xs font-extrabold">Dostępne</span>
    </button>
    <button data-view="options">
      <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z"/></svg>
      <span class="text-xs font-extrabold">Opcje</span>
    </button>
  </nav>

  <script>
    /* ========= KONFIG ========= */
    const BASE_URL = localStorage.getItem("pf_base") || "https://api.pkportfolio.pl";
    document.getElementById('baseUrlLabel').textContent = BASE_URL;

    const AUTH_KEY = 'pf_token';
    const token = () => localStorage.getItem(AUTH_KEY) || '';
    const setToken = t => t ? localStorage.setItem(AUTH_KEY, t) : localStorage.removeItem(AUTH_KEY);

    const sel = id => document.getElementById(id);

    async function api(path, opt={}) {
      const headers = opt.headers || {};
      headers['Content-Type'] = headers['Content-Type'] || 'application/json';
      const t = token();
      if (t) headers['Authorization'] = 'Bearer ' + t;
      const url = path.startsWith('http') ? path : (BASE_URL + path);
      const res = await fetch(url, {...opt, headers});
      if (res.status === 401) throw new Error("401 Unauthorized");
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await res.json();
      return await res.text();
    }

    /* ========= THEME ========= */
    const themeToggle = sel('themeToggle');
    const savedTheme = localStorage.getItem('pf-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.body.setAttribute('data-theme', savedTheme);
    if (themeToggle) themeToggle.checked = (savedTheme === 'light');
    themeToggle?.addEventListener('change', () => {
      const t = themeToggle.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
      document.body.setAttribute('data-theme', t);
      localStorage.setItem('pf-theme', t);
    });

    /* ========= NAV + AUTH ========= */
    const who = sel('who');

    function isLogged(){ return !!token(); }
    function showView(id){
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      sel(id)?.classList.add('active');
    }
    function showAppOrAuth(){
      if(!isLogged()) showView('auth'); else showView('torrents');
    }
    document.querySelectorAll('.navx [data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(!isLogged()) return showAppOrAuth();
        showView(btn.dataset.view);
        history.replaceState(null,'','#'+btn.dataset.view);
      });
    });

    async function refreshUser(){
      try{
        const j = await api('/auth/whoami', {method:'GET'});
        who.innerHTML = `<span class="opacity-80">zalogowany:</span> ${j.email}`;
      }catch{ who.textContent = 'niezalogowany'; }
    }

    // auth slider
    (function(){
      const rail = sel('authRail');
      const tabLogin = sel('tabLogin');
      const tabRegister = sel('tabRegister');
      const setPane = w=>{
        rail.style.transform = (w==='register') ? 'translateX(-50%)' : 'translateX(0)';
        tabLogin.classList.toggle('active', w==='login');
        tabRegister.classList.toggle('active', w==='register');
      };
      tabLogin.onclick = ()=>setPane('login');
      tabRegister.onclick = ()=>setPane('register');

      // swipe
      let sx=null;
      rail.addEventListener('touchstart', e=>sx=e.touches[0].clientX, {passive:true});
      rail.addEventListener('touchend', e=>{
        if(sx==null) return; const dx=e.changedTouches[0].clientX - sx;
        if(dx<-30) setPane('register'); if(dx>30) setPane('login'); sx=null;
      }, {passive:true});

      // login
      sel('btnLogin').onclick = async ()=>{
        const email = sel('loginEmail').value.trim();
        const password = sel('loginPass').value;
        const msg = sel('loginMsg');
        msg.textContent = '...';
        try{
          const j = await api('/auth/login', {method:'POST', body: JSON.stringify({email, password})});
          setToken(j.access_token);
          msg.textContent = '✅';
          await refreshUser();
          // initial loads
          await Promise.all([loadDevices(), loadAvailable(), loadQueue(), loadTorrents(), loadCastPlayers(), loadCastStatus()]);
          showAppOrAuth();
        }catch(e){
          msg.textContent = '❌ ' + (e.message||e);
          setToken('');
          await refreshUser();
        }
      };

      // register
      sel('btnRegister').onclick = async ()=>{
        const email = sel('regEmail').value.trim().toLowerCase();
        const p1 = sel('regPass').value;
        const p2 = sel('regPass2').value;
        const msg = sel('regMsg');
        if(!/^\S+@\S+\.\S+$/.test(email)) return msg.textContent='❌ Nieprawidłowy email';
        if(p1.length<6) return msg.textContent='❌ Hasło min. 6 znaków';
        if(p1!==p2) return msg.textContent='❌ Hasła się różnią';
        try{
          const regRes = await api('/auth/register', {method:'POST', body: JSON.stringify({email, password:p1})});
          let tokens = regRes?.access_token ? regRes : await api('/auth/login', {method:'POST', body: JSON.stringify({email, password:p1})});
          setToken(tokens.access_token);
          msg.textContent='✅ Utworzono, zalogowano';
          await refreshUser();
          await Promise.all([loadDevices(), loadAvailable(), loadQueue(), loadTorrents(), loadCastPlayers(), loadCastStatus()]);
          showAppOrAuth();
        }catch(e){ msg.textContent = '❌ ' + (e.message||e); }
      };

      sel('btnLogout').onclick = async ()=>{ setToken(''); await refreshUser(); showAppOrAuth(); };
    })();

    /* ========= DEVICES (torrent) ========= */
    function activeDevice(){ return localStorage.getItem("pf_device") || ""; }
    function setActiveDevice(id){
      if(id){ localStorage.setItem("pf_device", id); } else { localStorage.removeItem("pf_device"); }
      if(sel('deviceSel').value !== id) sel('deviceSel').value = id || "";
      sel('devInfo').textContent = id ? `Aktywne: ${id}` : 'Wybierz urządzenie';
      loadTorrents(); loadQueue();
    }

    async function loadDevices(){
      const deviceSel = sel('deviceSel');
      deviceSel.innerHTML = '';
      try{
        let list = [];
        try{
          list = await api('/torrents/devices', {method:'GET'});
        }catch(_){
          const j = await api('/torrents/status/list?limit=1&order=desc', {method:'GET'});
          const one = Array.isArray(j) ? j[0] : null;
          if(one?.device_id) list = [{device_id: one.device_id, torrents:1, last_status_at: one.updated_at, pending_commands:0}];
        }
        if(!Array.isArray(list)) list = [];
        const opts = list.map(d=>{
          const label = `${d.device_id}  —  torrents:${d.torrents||0}  pending:${d.pending_commands||0}`;
          return `<option value="${d.device_id}">${label}</option>`;
        });
        deviceSel.innerHTML = `<option value="">— wybierz urządzenie —</option>` + opts.join('');
        const prev = activeDevice();
        if(prev && list.some(x=>x.device_id===prev)) deviceSel.value = prev;
        else if(list.length===1) deviceSel.value = list[0].device_id;
        setActiveDevice(deviceSel.value);
      }catch(e){
        deviceSel.innerHTML = `<option value="">(błąd: ${e.message||e})</option>`;
      }
    }
    sel('devRefresh').onclick = loadDevices;
    sel('deviceSel').addEventListener('change', ()=> setActiveDevice(sel('deviceSel').value));

    /* ========= TORRENTS ========= */
    let tAutoTimer=null;
    function fmtBytes(n){
      n = Number(n||0);
      const u=['B','KiB','MiB','GiB','TiB']; let i=0;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed(n<10?2:1)} ${u[i]}`;
    }
    function fmtSpeed(bps){ return fmtBytes(bps) + '/s'; }
    function fmtETA(sec){ sec=Number(sec||-1); if(sec<0) return '—'; const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60; return `${h? h+'h ':''}${m? m+'m ':''}${s?s+'s':''}`.trim()||'0s'; }

    async function pushCmd(kind, info_hash=null, args={}){
      const dev = activeDevice();
      if(!dev){ alert('Najpierw wybierz urządzenie.'); return; }
      await api('/torrents/commands/push', {method:'POST', body: JSON.stringify({device_id: dev, info_hash, kind, args})});
    }

    async function loadTorrents(){
      const dev = activeDevice();
      const tInfo = sel('tInfo');
      const torList = sel('torList');
      if(!dev){ tInfo.textContent='Wybierz urządzenie'; torList.innerHTML=''; return; }
      try{
        const hideDone = sel('hideDone').checked;
        const qs = new URLSearchParams({device_id: dev, limit:'500', order:'desc'});
        const j = await api('/torrents/status/list?' + qs.toString(), {method:'GET'});
        const items = Array.isArray(j) ? j : [];
        const filtered = hideDone ? items.filter(r => Math.round((r.progress||0)*100) < 100) : items;
        tInfo.textContent = `Pozycje: ${filtered.length}`;
        torList.innerHTML = filtered.map(r=>{
          const p = Math.round((r.progress||0)*100);
          const size = fmtBytes(r.size_bytes);
          const dled = fmtBytes(r.downloaded_bytes);
          const sp = `📥 ${fmtSpeed(r.dl_speed)} · 📤 ${fmtSpeed(r.ul_speed)} · ⏱ ${fmtETA(r.eta)}`;
          return `
            <div class="tile card">
              <div class="flex-1 min-w-0">
                <div class="font-extrabold truncate">${(r.display_title||r.name||'—').replace(/</g,'&lt;')}</div>
                <div class="text-sm opacity-80 mt-1">${sp}</div>
                <div class="progress mt-2"><i style="width:${p}%"></i></div>
                <div class="text-xs opacity-80 mt-1">${p}% · ${dled} / ${size} · ratio ${(r.ratio||0).toFixed(2)}</div>
                <div class="flex gap-2 mt-2 flex-wrap">
                  <button class="px-3 py-2 rounded-lg card" onclick="window.t_pause('${r.info_hash}')">⏸️</button>
                  <button class="px-3 py-2 rounded-lg card" onclick="window.t_resume('${r.info_hash}')">▶️</button>
                  <button class="px-3 py-2 rounded-lg card" onclick="window.t_recheck('${r.info_hash}')">♻️ Recheck</button>
                  <button class="px-3 py-2 rounded-lg card" onclick="window.t_remove('${r.info_hash}', false)">🗑️</button>
                  <button class="px-3 py-2 rounded-lg card" onclick="window.t_remove('${r.info_hash}', true)">🗑️+📁</button>
                  <div class="flex items-center gap-2 text-sm">
                    <span>Limit MiB/s:</span>
                    <input id="rate_${r.info_hash}" type="number" step="0.1" class="card px-2 py-1" style="width:90px">
                    <button class="px-2 py-1 rounded-lg card" onclick="window.t_rate('${r.info_hash}', 'rate_${r.info_hash}')">Ustaw</button>
                  </div>
                </div>
              </div>
            </div>`;
        }).join('');
      }catch(e){
        sel('tInfo').textContent = '❌ ' + (e.message||e);
      }
    }
    sel('tRefresh').onclick = loadTorrents;
    sel('tAuto').onclick = ()=>{ if(tAutoTimer){ clearInterval(tAutoTimer); tAutoTimer=null; sel('tAuto').textContent='Auto: OFF'; } else { tAutoTimer=setInterval(loadTorrents, 4000); sel('tAuto').textContent='Auto: ON'; loadTorrents(); } };
    sel('hideDone').addEventListener('change', loadTorrents);
    window.t_pause = async ih=>{ await pushCmd('pause', ih); setTimeout(loadTorrents, 500); };
    window.t_resume = async ih=>{ await pushCmd('resume', ih); setTimeout(loadTorrents, 500); };
    window.t_remove = async (ih, withData)=>{ if(!confirm(withData?'Usunąć TORRENT + DANE?':'Usunąć torrent z klienta?')) return; await pushCmd(withData?'remove_data':'remove', ih); setTimeout(loadTorrents, 700); };
    window.t_recheck = async ih=>{ await pushCmd('recheck', ih); setTimeout(loadTorrents, 500); };
    window.t_rate = async (ih, inputId)=>{ const v=parseFloat(sel(inputId).value||'0'); await pushCmd('set_rate', ih, {limit_mbs:isNaN(v)?0:v}); setTimeout(loadTorrents, 400); };
    sel('setGlobRate').onclick = async ()=>{ const v=parseFloat(sel('globRate').value||'0'); await pushCmd('set_rate_global', null, {limit_mbs:isNaN(v)?0:v}); };

    /* ========= SEARCH ========= */
    let searchProvider = 'yts_html';
    document.querySelectorAll('#searchTabs .tab').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('#searchTabs .tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        searchProvider = b.dataset.src;
        sel('searchInfo').textContent = '';
        sel('searchResults').innerHTML = '';
      });
    });

    function cardTemplate(item){
      const img = item.image || '';
      const title = item.title || '—';
      const desc = item.description || '';
      const provider = item.provider || '—';
      const hasMagnet = !!item.magnet;
      const url = item.url || '';
      const rating = item.rating ? `★ ${item.rating}` : '';
      const id = btoa((url || item.magnet || title).slice(0,200)).replace(/=+/g,'');
      const qSel = `<select id="q_${id}" class="card px-2 py-1">
        <option value="">auto</option>
        <option value="2160p">2160p</option>
        <option value="1080p" selected>1080p</option>
        <option value="720p">720p</option>
      </select>`;
      const resolveBtn = (!hasMagnet && url)
        ? `<button class="px-3 py-2 rounded-lg card" onclick="window.resolveAndQueue('${encodeURIComponent(url)}','${provider}','${id}')">Resolve & Add</button>` : '';
      const addBtn = hasMagnet
        ? `<button class="px-3 py-2 rounded-lg card" onclick="window.addToQueue('${encodeURIComponent(item.magnet)}','${id}')">Add to Queue</button>` : '';
      return `
        <div class="card overflow-hidden">
          <img src="${img}" alt="">
          <div class="p-3">
            <h3 class="font-semibold">${title}</h3>
            <div class="text-sm opacity-80 mb-1"><span class="px-2 py-0.5 rounded-full border border-white/20 mr-2">${provider}</span> ${rating}</div>
            <p class="text-sm opacity-90 min-h-[40px]">${desc}</p>
            <div class="flex items-center gap-2 mt-2 flex-wrap">${resolveBtn}${addBtn}<span class="text-sm opacity-80">Jakość: ${qSel}</span></div>
          </div>
        </div>`;
    }
    function extractCardMeta(id){
      const card = document.getElementById('card_' + id) || document.querySelector(`[id*="${id}"]`);
      if(!card) return {title:'', image:''};
      const title = (card.querySelector('h3')?.textContent || '').trim();
      const image = (card.querySelector('img')?.getAttribute('src') || '').trim();
      return {title, image};
    }

    async function searchNow(){
      const q = sel('q').value.trim();
      if(!q) return;
      const body = {
        query: q,
        provider: searchProvider,
        type: sel('mtype').value.trim(),
        page: 1,
        extra: {}
      };
      const tmdb = (sel('tmdbKey').value || '').trim(); if(tmdb) body.extra.tmdb_api_key = tmdb;
      sel('searchInfo').textContent = `Szukam w: ${searchProvider}…`;
      sel('searchResults').innerHTML = '';
      try{
        const j = await api('/search', {method:'POST', body: JSON.stringify(body)});
        const items = j.results || [];
        sel('searchInfo').textContent = `Wyniki: ${items.length}`;
        sel('searchResults').innerHTML = items.map(cardTemplate).join('');
      }catch(e){ sel('searchInfo').textContent = '❌ ' + (e.message||e); }
    }
    sel('btnSearch').onclick = searchNow;
    sel('q').addEventListener('keydown', e=>{ if(e.key==='Enter') searchNow(); });

    window.resolveAndQueue = async (encodedUrl, provider, id)=>{
      const url = decodeURIComponent(encodedUrl);
      const quality = (sel('qualitySel').value || '');
      try{
        const j = await api('/search/resolve', {method:'POST', body: JSON.stringify({url, provider, quality})});
        if(!j.magnet){ alert('Nie udało się wyciągnąć magnet linku.'); return; }
        await addToQueue(encodeURIComponent(j.magnet), id);
        await loadQueue();
      }catch(e){ alert('Resolve error: ' + (e.message||e)); }
    };
    window.addToQueue = async (encMagnet, id)=>{
      const magnet = decodeURIComponent(encMagnet);
      const download_kind = sel('mtype').value || 'movie';
      const qval = (id && sel('q_'+id)) ? sel('q_'+id).value : (sel('qualitySel').value || '');
      const metaFromCard = id ? extractCardMeta(id) : {title:'', image:''};
      try{
        const meta = { from:'pwa', save_slot:download_kind, display_title:metaFromCard.title||undefined, image_url:metaFromCard.image||undefined, quality:qval||undefined };
        const payload = { magnet, download_kind, meta };
        await api('/torrent/add', {method:'POST', body: JSON.stringify(payload)});
        alert('Dodano do kolejki.');
        await loadQueue();
      }catch(e){ alert('Add error: ' + (e.message||e)); }
    };

    /* ========= QUEUE (read-only w tej PWA) ========= */
    async function loadQueue(){
      const params = new URLSearchParams();
      const dev = (activeDevice() || '').trim(); if(dev) params.set('device_id', dev);
      params.set('limit', '100');
      try{
        const j = await api('/queue/list' + (params.toString()?('?' + params.toString()):''), {method:'GET'});
        // minimalny badge przy Torrents header
        const items = Array.isArray(j) ? j : (j.items || []);
        // Możesz dodać wskaźnik w UI — tutaj pomijam, lista kolejek jest w Twoim panelu administracyjnym
        console.debug('Queue items:', items.length);
      }catch(e){ console.warn('queue error', e); }
    }

    /* ========= AVAILABLE + CAST ========= */
    let avAutoTimer=null, delTimer=null, _availableRaw=[], _availableIndex={}, _posterByPlexId={};
    const avGrid = sel('avGrid'), avInfo = sel('avInfo');

    function _first(obj, keys, dflt=''){ for(const k of keys){ if(obj && obj[k]!=null && obj[k]!== '') return obj[k]; } return dflt; }
    function _num(x, d=0){ const n=Number(x); return isFinite(n)?n:d; }
    function _bool(x){ return !!(x===true || x==='1' || x===1); }
    function _parseDeleteAt(val){
      if(val==null || val==='') return null;
      if(typeof val === 'number'){ const n=Number(val); if(!isFinite(n)) return null; return n<1e12 ? Math.round(n*1000) : Math.round(n); }
      const s=String(val).trim(); if(!s) return null;
      const asNum=Number(s); if(isFinite(asNum)) return asNum<1e12 ? Math.round(asNum*1000) : Math.round(asNum);
      const t=Date.parse(s); return isNaN(t) ? null : t;
    }
    function pickPlexId(raw){
      const cand=[raw?.plex_id,raw?.ratingKey,raw?.plex_rating_key,raw?.id].find(v=>v!=null && String(v).trim()!=='');
      if(!cand) return null; const s=String(cand).trim(); return /^\d+$/.test(s)?s:null;
    }
    function canonItem(r){
      const title=_first(r,['display_title','title','name'],'—');
      const poster=_first(r,['image_url','poster','poster_url','thumb','cover','cover_url'],'');
      const kindRaw=(_first(r,['kind','type','mtype','media_type'],'')||'').toLowerCase();
      const isSeries=kindRaw==='series'||_bool(r.is_series)||!!r.season||!!r.episode;
      const kind=isSeries?'series':'movie';
      const year=_first(r,['year','release_year','y'],null);
      const dur=_num(_first(r,['duration','runtime','total_seconds','duration_sec'],0));
      const pos=_num(_first(r,['watched_seconds','position','last_position','pos'],0));
      let prog=_num(_first(r,['progress','ratio','percent'],null));
      if(prog!=null){ prog = prog>1.01 ? (prog/100) : prog; } else if(dur>0){ prog=Math.max(0, Math.min(1, pos/dur)); } else prog=0;
      const season=_num(_first(r,['season','s'],null),null);
      const episode=_num(_first(r,['episode','e'],null),null);
      const updated_at=_first(r,['updated_at','mtime','added_at','ts','last_update'],null);
      let idCand=_first(r,['plex_id','ratingKey','plex_rating_key'],null); if(!idCand) idCand=_first(r,['id','item_id','video_id','hash'],null);
      let id; if(idCand && String(idCand).match(/^\d+$/)){ id=String(idCand);} else { id=btoa(unescape(encodeURIComponent((title||'')+'|'+(year||'')+'|'+(season||'')+'|'+(episode||'')))).replace(/=+$/,''); }
      const size_bytes=_num(_first(r,['size_bytes','filesize','size'],0));
      const delRaw=_first(r,['deleteAt','delete_at'],null);
      const deleteAt=_parseDeleteAt(delRaw);
      const favorite=_bool(_first(r,['favorite'],false));
      return {id,title,poster,kind,year,duration:dur,position:pos,progress:prog,season,episode,updated_at,size_bytes,deleteAt,favorite};
    }
    function _episodeLabel(it){ if(it.kind!=='series') return ''; const s=it.season!=null?String(it.season).padStart(2,'0'):'--'; const e=it.episode!=null?String(it.episode).padStart(2,'0'):'--'; return `S${s}E${e}`; }
    function fmtTTL(diffMs){
      if(diffMs<=0) return 'do usunięcia';
      const s=Math.floor(diffMs/1000); const d=Math.floor(s/86400); const h=Math.floor((s%86400)/3600); const m=Math.floor((s%3600)/60);
      if(d>=2) return `za ${d} dni`; if(d===1) return `za 1 dzień`; if(h>=1) return `za ${h} h`; return `za ${m} min`;
    }
    function delClass(diffMs){ if(diffMs<=0) return 'danger'; const d=diffMs/86400000; if(d<=1) return 'warn'; return 'ok'; }
    function fmtDateShort(ms){ if(!ms) return ''; const d=new Date(ms); return d.toLocaleString(); }

    function renderAvailable(list){
      if(delTimer){ clearInterval(delTimer); delTimer=null; }
      if(!Array.isArray(list) || !list.length){ avGrid.innerHTML=''; avInfo.textContent='Brak danych.'; return; }
      const q=(sel('avQuery').value||'').toLowerCase();
      const k=sel('avKind').value||'all';
      const sort=sel('avSort').value||'recent';

      _availableIndex={}; _posterByPlexId={};
      let items=list.map(r=>{ const c=canonItem(r); _availableIndex[c.id]=r; return c; });
      if(k!=='all') items=items.filter(x=>x.kind===k);
      if(q) items=items.filter(x=>(x.title||'').toLowerCase().includes(q));

      for(const raw of list){ const pid=pickPlexId(raw); if(!pid) continue; const c=canonItem(raw); if(c.poster) _posterByPlexId[String(pid)]=c.poster; }

      if(sort==='title') items.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); 
      else if(sort==='progress') items.sort((a,b)=>(b.progress||0)-(a.progress||0));
      else items.sort((a,b)=> String(b.updated_at||'').localeCompare(String(a.updated_at||'')));

      avGrid.innerHTML = items.map(it=>{
        const pct = Math.max(0, Math.min(100, Math.round((it.progress||0)*100)));
        const year = it.year ? ` (${it.year})` : '';
        const ep = _episodeLabel(it);
        const metaL = `${it.kind}${ep? ' · '+ep:''}${it.size_bytes? ' · '+fmtBytes(it.size_bytes):''}`;
        const delDiff = it.deleteAt ? (it.deleteAt - Date.now()) : null;
        const delTxt  = (it.deleteAt && !it.favorite) ? fmtTTL(delDiff) : '';
        const delCls  = (it.deleteAt && !it.favorite) ? delClass(delDiff) : '';
        const delDate = (it.deleteAt && !it.favorite) ? ` · usunie: ${fmtDateShort(it.deleteAt)}` : '';
        const delBadge = (it.deleteAt && !it.favorite) ? `<div class="del-badge ${delCls}" data-delete-at="${it.deleteAt}">${delTxt}</div>` : '';
        const canAutoId = /^\d+$/.test(String(it.id));
        const tip = canAutoId ? `Cast ratingKey=${it.id}` : `Wpisz ratingKey przy starcie`;

        return `
        <div class="card overflow-hidden">
          <div class="relative">
            <img src="${it.poster||''}" alt="">
            ${delBadge}
            <div class="progress absolute left-3 right-3 bottom-3 h-2 rounded"><i style="width:${pct}%"></i></div>
          </div>
          <div class="p-3">
            <div class="font-semibold line-clamp-2">${(it.title||'—').replace(/</g,'&lt;')}${year}</div>
            <div class="text-xs opacity-80 mt-1">${metaL}${delDate}</div>
            <div class="text-xs opacity-80">Postęp: ${pct}% ${it.duration? `· ${Math.round((it.position||0)/60)} / ${Math.round((it.duration||0)/60)} min` : ''}</div>
            <div class="flex gap-2 mt-2">
              <button class="px-3 py-2 rounded-lg card" title="${tip}" onclick="castFromAvailable('${it.id}')">📺 CAST</button>
            </div>
          </div>
        </div>`;
      }).join('');
      avInfo.textContent = `Pozycji: ${items.length}`;

      const refreshBadges = ()=>{
        document.querySelectorAll('.del-badge[data-delete-at]').forEach(el=>{
          const ts=Number(el.getAttribute('data-delete-at')||''); if(!isFinite(ts)) return;
          const diff=ts-Date.now(); el.textContent = fmtTTL(diff);
          el.classList.remove('ok','warn','danger'); el.classList.add(delClass(diff));
        });
      };
      delTimer=setInterval(refreshBadges, 30000);
    }

    async function loadAvailable(){
      avInfo.textContent='Ładuję...';
      avGrid.innerHTML='';
      const candidates=['/library/available','/sync/available','/available','/library'];
      let data=null;
      for(const p of candidates){
        try{
          const j=await api(p,{method:'GET'});
          if(Array.isArray(j)){ data=j; break; }
          if(j && (Array.isArray(j.items)||Array.isArray(j.results))){ data=j.items||j.results; break; }
        }catch(_){}
      }
      if(!data){ avInfo.textContent='Nie znaleziono endpointu available.'; return; }
      _availableRaw=data;
      renderAvailable(_availableRaw);
    }
    sel('avRefresh').onclick=loadAvailable;
    sel('avAuto').onclick=()=>{ if(avAutoTimer){ clearInterval(avAutoTimer); avAutoTimer=null; sel('avAuto').textContent='Auto: OFF'; } else { avAutoTimer=setInterval(loadAvailable, 10000); sel('avAuto').textContent='Auto: ON'; loadAvailable(); } };
    sel('avQuery').addEventListener('input', ()=>renderAvailable(_availableRaw));
    sel('avKind').addEventListener('change', ()=>renderAvailable(_availableRaw));
    sel('avSort').addEventListener('change', ()=>renderAvailable(_availableRaw));

    // CAST
    function castClient(){ return localStorage.getItem('pf_cast_client') || ''; }
    function setCastClient(id){ id? localStorage.setItem('pf_cast_client', id) : localStorage.removeItem('pf_cast_client'); }
    async function loadCastPlayers(){
      try{
        const j = await api('/cast/players',{method:'GET'});
        const list = Array.isArray(j?.devices) ? j.devices : [];
        if(!list.length) return;
        const prev = castClient();
        const curr = (prev && list.some(x=>x.id===prev)) ? prev : list[0].id;
        setCastClient(curr);
      }catch(_){}
    }

    async function castStart(itemId){
      const cid = castClient();
      if(!cid){ alert('Wybierz najpierw klienta Plex (endpoint /cast/players).'); return; }
      try{
        await api('/cast/start', {method:'POST', body: JSON.stringify({ item_id:String(itemId), client_id: cid })});
        alert('CAST: OK');
      }catch(e){ alert('CAST error: ' + (e.message||e)); }
    }
    window.castFromAvailable = async (canonId)=>{
      const raw = _availableIndex[canonId] || {};
      let itemId = pickPlexId(raw);
      if(!itemId && /^\d+$/.test(String(canonId))) itemId = String(canonId);
      if(!itemId){ itemId = prompt('Brak plex_id. Podaj Plex ratingKey (item_id):',''); }
      if(!itemId || !/^\d+$/.test(String(itemId))){ alert('Nieprawidłowy item_id.'); return; }
      await castStart(itemId);
    };

    async function loadCastStatus(){ try{ await api('/cast/status',{method:'GET'}); }catch(_){} }

    /* ========= PWA register ========= */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }

    /* ========= START ========= */
    (async ()=>{
      await refreshUser();
      await loadDevices();
      await loadAvailable();
      await loadQueue();
      await loadCastPlayers();
      await loadCastStatus();
      const hash=(location.hash||'').replace('#',''); showAppOrAuth(); if(isLogged() && hash){ document.querySelector(`.navx [data-view="${hash}"]`)?.click(); }
    })();
  </script>
</body>
</html>
